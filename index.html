<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Agricultural Advisory System</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
:root{ --red:#e74c3c; --green:#2e8b57; --green-dark:#246b45;}
body{ font-family:'Poppins',sans-serif; margin:0; padding:0; background:rgba(200,255,200,0.25); background-image:url('background.jpg'); background-size:cover; background-position:center;}
header{text-align:center; background:var(--green); color:#fff; padding:18px 10px; font-size:26px; font-weight:700;}
.container{ max-width:980px; margin:28px auto; background:#ffffffe6; padding:22px; border-radius:14px; box-shadow:0 6px 30px rgba(0,0,0,0.15);}
.profile{ display:flex; justify-content:flex-end; align-items:center; gap:14px; animation:fadeIn 1s ease-in-out;}
.profile img{ width:50px; height:50px; border-radius:50%; object-fit:cover; border:2px solid #C0392B; animation:pulse 2s infinite;}
.profile .subtitle{text-align:center; font-size:12px; color:#16A085; line-height:1.1; white-space:pre-line; animation:fadeIn 1s ease-in-out;}
form .row{ display:flex; gap:18px; align-items:flex-start; flex-wrap:wrap; }
.left, .right { flex:1 1 420px; min-width:320px; }
label{ display:block; margin-top:8px; font-weight:600; color:#222; }
input, select, button { width:100%; padding:10px; margin-top:6px; border-radius:8px; border:1px solid #ccc; font-size:15px; }
button{ background:#27AE60; color:white; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:6px; animation:fadeIn 1s ease-in-out;}
button:hover{ background:#E67E22; animation:bounce 0.5s;}
button.vertical{ flex-direction:column; padding:12px; font-size:16px;}
#adviceResult{ margin-top:16px; padding:15px; border-radius:10px; background: rgba(255,0,0,0.04); font-weight:600; color:#333; white-space:pre-line; animation:fadeIn 1s ease-in-out;}
canvas{ margin-top:20px; width:100% !important; height:400px !important; }
.crop-thumbs{ display:flex; gap:20px; flex-wrap:wrap; margin-top:20px; }
.thumb{ width:100px; height:100px; border-radius:10px; overflow:hidden; border:2px solid transparent; cursor:pointer; text-align:center; display:flex; align-items:center; justify-content:center; background:#fff; box-shadow:0 2px 8px rgba(0,0,0,0.08); }
.thumb img{ width:180%; height:150%; object-fit:cover; display:block; }
.thumb.selected{ border-color:var(--red); box-shadow:0 4px 14px rgba(231,76,60,0.3); }
.lang-area{ text-align:center; margin-top:8px; }
.meta-small{ font-size:13px; color:#555; margin-top:6px; }

/* Global mic style */
.globalMicBtn{ background:#E67E22; color:#fff; font-weight:bold; border-radius:50%; width:30px; height:30px; display:flex; align-items:center; justify-content:center; margin:auto; margin-bottom:12px; animation: pulse 1.5s infinite; cursor:pointer; border:3px solid #fff; font-size:20px;}
.globalMicBtn.listening {
  box-shadow: 0 0 0 8px rgba(255,0,0,0.12), 0 0 24px rgba(255,0,0,0.08);
  transform: scale(2.08);
  border-color: #1ABC9C;
  outline: 5px solid rgba(255,0,0,0.08);
  animation: pulse 1s infinite;
}
.globalMicBtn[aria-pressed="true"]::after{
  content: " ‚Ä¢ listening";
  font-size:14px;
  margin-left:12px;
  opacity:0.9;
}

/* FRAME ya ramani */
#mapContainer {
  position: relative;
  width: 100%;
  height: auto;
  border: 3px solid #1abc9c;
  border-radius: 10px;
  overflow: hidden;
  margin-top: 22px;
  box-shadow: 0 4px 16px rgba(0,0,0,0.18);
}

/* Ramani yenyewe */
#map {
  width: 50%;
  height: 480px;
}

/* Spinner wakati inatafuta location */
#locSpinner {
  position: absolute;
  top: 50%; 
  left: 50%;
  transform: translate(-50%, -50%);
  width: 70px;
  height: 70px;
  border: 8px solid #ddd;
  border-top: 8px solid #27ae60;
  border-radius: 50%;
  animation: spin 0.9s linear infinite;
  display: none;
  z-index: 2000;
}

@keyframes spin {
  0% { transform: translate(-50%,-50%) rotate(0deg); }
  100% { transform: translate(-50%,-50%) rotate(360deg); }
}

/* Button ya Use My Location */
.mapLocationBtn {
  position: absolute;
  bottom: 15px;
  right: 15px;
  background: #27AE60;
  color: #fff;
  border: none;
  padding: 10px 12px;
  border-radius: 8px;
  font-weight: 700;
  box-shadow: 0 4px 18px rgba(0,0,0,0.2);
  cursor: pointer;
  z-index: 2000;
}
.mapLocationBtn:hover {
  background: #1e8b4c;
}

@keyframes pulse{0%{transform:scale(1);}50%{transform:scale(1.2);}100%{transform:scale(1);} }
@keyframes bounce{0%,100%{transform:translateY(0);}50%{transform:translateY(-6px);} }
.fade-in{ animation:fadeIn 0.8s ease-in-out; }
@keyframes fadeIn{ from {opacity:0; transform: translateY(10px);} to {opacity:1; transform:translateY(0);} }
</style>
</head>
<body>
<header id="siteHeader">
  Agricultural Advisory System
  <div class="lang-area">
    <button id="langToggle">üåê change Language / Badilisha Lugha</button>
  </div>
</header>

<div class="container fade-in">
  <div class="profile">
    <div><img id="profileImg" src="profile.jpg" alt="Profile"></div>
    <div class="subtitle">

Name: Taisoni Ambokile Mwaluswaswa
‚òéÔ∏èüìû0749458547‚òé 
GIS and RS Expert
üìß taisonimwuluswaswa@gmail.com

    </div>
  </div>

  <div id="mapContainer">
    <div id="map"></div>
    <div id="locSpinner"></div>
    <button id="useLocationBtn" class="mapLocationBtn">üìç Use My Location</button>
</div>

  <form id="mainForm" onsubmit="return false;">
    <div class="row">
      <div class="left">

        <!-- GLOBAL MIC BUTTON -->
        <div class="globalMicBtn" id="globalMicBtn" title="Voice Command">üé§</div>

        <label id="lblName">Full Name:</label>
        <input id="farmerName" type="text" placeholder="Enter your name" />

        <label id="lblGender">Gender:</label>
        <select id="gender">
          <option value="">Select Gender</option>
          <option value="male">üßëüèæ‚Äç Male</option>
          <option value="female">üßïüèæ Female</option>
        </select>

        <label id="lblRegion">Region:</label>
        <select id="region"></select>

        <label id="lblCrop">Crop:</label>
        <select id="cropSelect"></select>

        <div class="crop-thumbs" id="cropThumbs" aria-hidden="false"></div>
        <div class="meta-small">Tip: click thumbnail to choose crop.</div>
      </div>

      <div class="right">
        <label id="lblChartType">Chart Type:</label>
        <select id="chartType">
          <option value="line">Line (monthly)</option>
          <option value="bar">Bar</option>
        </select>

        <div style="display:flex; flex-direction:column; gap:12px; margin-top:12px;">
          <button type="button" class="vertical" onclick="showTrend()">üìä Show Trend</button>
          <button type="button" class="vertical" onclick="showAdvice()">üí¨ Show Advice</button>
          <button type="button" class="vertical" onclick="checkWeather()">üå¶Ô∏è Check Weather</button>
          <button type="button" class="vertical" onclick="forecast5Days()">üìà 5-Day Forecast</button>
        </div>

        <div id="adviceResult" aria-live="polite"></div>
        <canvas id="trendChart"></canvas>
      </div>
    </div>
  </form>
</div>

<script>
/* ===========================
   Existing app variables & data
   =========================== */
const apiKey = "4970f8ff4bc343c5721c08b2e682f022"; // OpenWeatherMap - keep as before
let currentLang = 'en';
let chartInstance = null;
const startYear = 2016, endYear = 2025;
const monthsNames = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
const totalMonths = (endYear-startYear+1)*12;

/* Regions list (used to find nearest region based on coords) */
const regionsAPI = [
  { name: "Songwe", lat: -9.258, lng: 33.642 },
  { name: "Mbeya", lat: -8.910, lng: 33.450 },
  { name: "Iringa", lat: -7.771, lng: 35.685 },
  { name: "Dodoma", lat: -6.163, lng: 35.751 },
  { name: "Morogoro", lat: -6.827, lng: 37.659 },
  { name: "Kilimanjaro", lat: -3.067, lng: 37.355 },
  { name: "Mwanza", lat: -2.516, lng: 32.900 },
  { name: "Arusha", lat: -3.386, lng: 36.680 },
  { name: "Tanga", lat: -5.070, lng: 39.100 },
  { name: "Ruvuma", lat: -10.634, lng: 35.616 },
  { name: "Dar es Salaam", lat: -6.7924, lng: 39.2083 },
  { name: "Tunduma", lat: -9.300, lng: 32.800 }
];

/* Crops + images + generated data (same as before) */
const cropsEN = ["Corn","Rice","Tea","Coffee","Beans","Potatoes","Cassava"];
const cropsSW = ["Mahindi","Mpunga","Chai","Kahawa","Maharage","Viazi","Ufuta"];
const cropImages = { Mahindi:"mahindi.jpg", Mpunga:"mpunga.jpg", Chai:"chai.jpg", Kahawa:"kahawa.jpg", Maharage:"maharage.jpg", Viazi:"viazi.jpg", Ufuta:"ufuta.jpg" };
const monthlyLabels=[];
for(let y=startYear; y<=endYear; y++){
  for(let m=0;m<12;m++){ monthlyLabels.push(`${y} ${monthsNames[m]}`); }
}
const cropData = {};
cropsSW.forEach(c=>{
  const rainfall=[], temperature=[], ndvi=[];
  for(let i=0;i<totalMonths;i++){
    const monthIndex=i%12;
    let baseRain=100, baseTemp=22, baseNDVI=0.5;
    switch(c){
      case "Mahindi": baseRain=90; baseTemp=22; baseNDVI=0.45; break;
      case "Mpunga": baseRain=160; baseTemp=27; break;
      case "Chai": baseRain=140; baseTemp=19; baseNDVI=0.7; break;
      case "Kahawa": baseRain=130; baseTemp=21; baseNDVI=0.6; break;
      case "Maharage": baseRain=110; baseTemp=24; baseNDVI=0.5; break;
      case "Ufuta": baseRain=85; baseTemp=23; baseNDVI=0.44; break;
    }
    const seasonFactor = 1 + 0.5 * Math.sin((monthIndex/12)*2*Math.PI + (c.length % 3));
    rainfall.push(Math.max(0, Math.round(baseRain*seasonFactor + Math.random()*40-20)));
    temperature.push(Math.max(0, +(baseTemp + Math.cos((monthIndex/12)*2*Math.PI)*2 + Math.random()*4-2).toFixed(1)));
    ndvi.push(Math.max(0, +(baseNDVI + Math.sin((monthIndex/12)*2*Math.PI)*0.05 + Math.random()*0.16-0.08).toFixed(2)));
  }
  let req="";
  switch(c){
    case "Mahindi": req=" about 500‚Äì800 mm rainfall/year and 18‚Äì27¬∞C."; break;
    case "Mpunga": req="Requires 1000‚Äì2000 mm rainfall/year and warm temps (>25¬∞C)."; break;
    case "Chai": req="Prefers 1200‚Äì2500 mm/year and 16‚Äì25¬∞C."; break;
    case "Kahawa": req="Needs 1000‚Äì2000 mm/year and 18‚Äì26¬∞C."; break;
    case "Maharage": req="Moderate rainfall 600‚Äì1200 mm and 18‚Äì28¬∞C."; break;
    case "Ufuta": req="Requires 600‚Äì900 mm and 18‚Äì26¬∞C."; break;
  }
  cropData[c] = { rainfall, temperature, ndvi, requirements:req };
});

/* ---------------- Populate crops & regions ---------------- */
const cropSelect = document.getElementById('cropSelect');
const thumbsDiv = document.getElementById('cropThumbs');
function populateCrops(){
  cropSelect.innerHTML="";
  thumbsDiv.innerHTML="";
  const list = currentLang==='en'?cropsEN:cropsSW;
  list.forEach((c,i)=>{
    const opt=document.createElement('option'); opt.value=c; opt.textContent=c; cropSelect.appendChild(opt);
    const t=document.createElement('div'); t.className='thumb'; t.dataset.crop=c;
    const img=document.createElement('img'); const fname=cropImages[cropsSW[i]] || 'placeholder.jpg';
    img.src=fname; img.alt=c; img.onerror=function(){this.src='placeholder.jpg';}
    t.appendChild(img);
    t.addEventListener('click', ()=>{
      cropSelect.value=c;
      document.querySelectorAll('.thumb').forEach(x=>x.classList.remove('selected'));
      t.classList.add('selected');
    });
    thumbsDiv.appendChild(t);
  });
}
populateCrops();

function populateRegions(){
  const regionSelect=document.getElementById('region');
  regionSelect.innerHTML='<option value="">Select Region</option>';
  regionsAPI.forEach(r=>{
    const opt=document.createElement('option'); opt.value=JSON.stringify(r); opt.textContent=r.name;
    regionSelect.appendChild(opt);
  });
}
populateRegions();
function getSelectedRegionData(){
  const val=document.getElementById('region').value;
  return val?JSON.parse(val):null;
}

/* ---------------- Sound & speech ---------------- */
const clickSoundURL='https://www.soundjay.com/buttons/sounds/button-16.mp3';
function playSound(){ try{ const a=new Audio(clickSoundURL); a.volume=0.35; a.play(); }catch(e){} }
function speakText(text, gender){
  const utter = new SpeechSynthesisUtterance(text);
  utter.lang=currentLang==='en'?'en-US':'sw-TZ';
  utter.pitch=gender==='female'?1.3:0.85;
  utter.rate=1;
  try{ window.speechSynthesis.cancel(); window.speechSynthesis.speak(utter); }catch(e){}
  playSound();
}

/* ---------------- Chart (same as before) ---------------- */
function showTrend(){
  const cropName=cropSelect.value;
  if(!cropName){ alert(currentLang==='en'?'Please select a crop first!':'Tafadhali chagua zao kwanza!'); return; }
  const type=document.getElementById('chartType').value;
  const ctx=document.getElementById('trendChart').getContext('2d');
  if(chartInstance) chartInstance.destroy();
  const keySW=cropsSW[cropsEN.indexOf(cropName)] || cropName;
  const dataObj=cropData[keySW];
  chartInstance=new Chart(ctx,{
    type:type,
    data:{
      labels:monthlyLabels,
      datasets:[
        {label:'Rainfall (mm)', data:dataObj.rainfall, yAxisID:'y', borderColor:'#2e8b57', backgroundColor:'#a3e4a3', tension:0.25, pointRadius:0,borderWidth:2},
        {label:'Temperature (¬∞C)', data:dataObj.temperature, yAxisID:'y1', borderColor:'#ff9933', backgroundColor:'#ffd699', tension:0.25, pointRadius:0,borderWidth:2},
        {label:'NDVI', data:dataObj.ndvi, yAxisID:'y2', borderColor:'#0066cc', backgroundColor:'#99ccff', tension:0.25, pointRadius:0,borderWidth:2}
      ]
    },
    options:{
      responsive:true,
      interaction:{mode:'index',intersect:false},
      stacked:false,
      scales:{
        x:{ display:true, ticks:{maxRotation:0, autoSkip:true, maxTicksLimit:20} },
        y:{ type:'linear', display:true, position:'left', title:{display:true,text:'Rainfall (mm)'} },
        y1:{ type:'linear', display:true, position:'right', grid:{ drawOnChartArea:false }, title:{display:true,text:'Temperature (¬∞C)'} },
        y2:{ type:'linear', display:false, position:'right', suggestedMin:0, suggestedMax:1 }
      },
      plugins:{ legend:{ display:true, position:'top' } }
    }
  });
  playSound();
}

/* ---------------- Advice (same as before) ---------------- */
function showAdvice(){
  const name=(document.getElementById('farmerName').value || (currentLang==='en'?'Farmer':'Mkulima')).trim();
  const cropName=cropSelect.value; 
  if(!cropName){ alert(currentLang==='en'?'Please select a crop first!':'Tafadhali chagua zao kwanza!'); return; }
  const gender=document.getElementById('gender').value;
  const schedule={
    Mahindi:{plant:'March', weed:'May', harvest:'August'},
    Mpunga:{plant:'May', weed:'July', harvest:'October'},
    Chai:{plant:'April', weed:'June', harvest:'December'},
    Kahawa:{plant:'May', weed:'July', harvest:'November'},
    Maharage:{plant:'March', weed:'April', harvest:'July'},
    Ufuta:{plant:'March', weed:'May', harvest:'August'}
  };
  const keySW=cropsSW[cropsEN.indexOf(cropName)] || cropName;
  const req=cropData[keySW].requirements;
  const schedObj=schedule[keySW];
  const adviceEN=`üôãüèæ Hello ${name}!\nCrop: ${cropName}\nRequirements: ${req}\nSchedule:\n- Planting: ${schedObj.plant}\n- Weeding: ${schedObj.weed}\n- Harvest: ${schedObj.harvest}`;
  const adviceSW=` ${name}üôãüèæ! \n kama unataka kulima: ${cropName}\n zao hili linahitaji: ${req}\nRatiba:\n- Kupanda: ${schedObj.plant}\n- Kupalilia: ${schedObj.weed}\n- Kuvuna: ${schedObj.harvest}`;
  const adviceText=currentLang==='en'?adviceEN:adviceSW;
  document.getElementById('adviceResult').innerText = adviceText;
  speakText(adviceText, gender);
}

/* ---------------- Weather functions ---------------- */
function checkWeather(){
  const region=getSelectedRegionData();
  if(!region){ alert(currentLang==='en'?'Please select a region first!':'Tafadhali chagua mkoa kwanza!'); return; }
  checkWeatherAt(region.lat, region.lng);
}

function checkWeatherAt(lat, lon){
  fetch(`https://api.openweathermap.org/data/2.5/forecast?lat=${lat}&lon=${lon}&units=metric&appid=${apiKey}`)
  .then(res=>res.json())
  .then(data=>{
    let text="";
    for(let i=0;i<5;i++){
      const dayData = data.list[i*8];
      if(currentLang==='en'){
        text+=`Day ${i+1} (${dayData.dt_txt.split(' ')[0]}): Temp ${dayData.main.temp}¬∞C, Humidity ${dayData.main.humidity}%, ${dayData.weather[0].description}, Rain chance ${(dayData.pop*100).toFixed(0)}%\n`;
      } else {
        text+=`Siku ${i+1} (${dayData.dt_txt.split(' ')[0]}): Joto ${dayData.main.temp}¬∞C, Unyevu ${dayData.main.humidity}%, ${dayData.weather[0].description}, Uwezekano wa mvua ${(dayData.pop*100).toFixed(0)}%\n`;
      }
    }
    document.getElementById('adviceResult').innerText=text;
    speakText(text,'female');

    // Build trend chart for 5 days
    const temps = [], rains = [];
    for(let i=0;i<5;i++){
      const d = data.list[i*8];
      temps.push(d.main.temp);
      rains.push(d.pop*100);
    }
    const ctx=document.getElementById('trendChart').getContext('2d');
    if(chartInstance) chartInstance.destroy();
    chartInstance = new Chart(ctx,{
      type:'line',
      data:{
        labels:[...Array(5)].map((_,i)=> currentLang==='en'?`Day ${i+1}`:`Siku ${i+1}`),
        datasets:[
          {label: currentLang==='en'?'Temperature ¬∞C':'Joto ¬∞C', data:temps, borderColor:'#ff9933', backgroundColor:'#ffd699', fill:false, tension:0.25},
          {label: currentLang==='en'?'Rain Chance %':'Uwezekano wa Mvua %', data:rains, borderColor:'#0066cc', backgroundColor:'#99ccff', fill:false, tension:0.25}
        ]
      },
      options:{ responsive:true, plugins:{ legend:{position:'top'} } }
    });
  }).catch(err=>{ alert(currentLang==='en'?'Weather API error':'Hitilafu ya Weather API'); console.error(err); });
}

/* ------------- Language toggle ------------- */
document.getElementById('langToggle').addEventListener('click', ()=>{
  currentLang=currentLang==='en'?'sw':'en';
  document.getElementById('siteHeader').innerText=currentLang==='en'?'Agricultural Advisory System':'Mfumo wa Ushauri Kilimo';
  document.getElementById('lblName').innerText=currentLang==='en'?'Full Name:':'Jina Kamili:';
  document.getElementById('lblGender').innerText=currentLang==='en'?'Gender:':'Jinsia:';
  document.getElementById('lblRegion').innerText=currentLang==='en'?'Region:':'Mkoa:';
  document.getElementById('lblCrop').innerText=currentLang==='en'?'Crop:':'Zao:';
  document.getElementById('lblChartType').innerText=currentLang==='en'?'Chart Type:':'Aina ya Chati:';
  // repopulate crops text & region text if needed
  populateCrops();
  populateRegions();
});

/* ------------- Voice recognition (same as before) ------------- */
const micBtn = document.getElementById('globalMicBtn');
let recognition = null;
let micActive = false;

function createRecognition(){
  const SpeechRec = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!SpeechRec) return null;
  const r = new SpeechRec();
  r.continuous = true;
  r.interimResults = false;
  r.maxAlternatives = 1;
  r.lang = currentLang === 'en' ? 'en-US' : 'sw-TZ';
  r.onresult = handleSpeechResult;
  r.onerror = (e) => {
    console.error('SpeechRecognition error:', e);
    stopListening();
    alert(currentLang==='en'?'Voice recognition error. Check microphone permissions.':'Hitilafu ya utambuzi wa sauti. Angalia ruhusa za mikrofoni.');
  };
  r.onend = () => {
    if(micActive){
      try { r.start(); } catch(e){ console.warn('Could not restart recognition', e); }
    } else {
      updateMicUI(false);
    }
  };
  r.onnomatch = (e) => { console.log('No match', e); };
  return r;
}

function startListening(){
  if(!('SpeechRecognition' in window) && !('webkitSpeechRecognition' in window)){
    alert(currentLang==='en'?'Your browser does not support Speech Recognition. Use Chrome on Android/desktop.':'Kivinjari chako hakitambulii utambuzi wa sauti. Tumia Chrome kwenye simu/kompyuta.');
    return;
  }
  if(!recognition) recognition = createRecognition();
  if(!recognition) return;
  recognition.lang = currentLang === 'en' ? 'en-US' : 'sw-TZ';
  try {
    recognition.start();
    micActive = true;
    updateMicUI(true);
    console.log('Recognition started, lang=', recognition.lang);
  } catch (e) {
    console.warn('Could not start recognition:', e);
  }
}

function stopListening(){
  micActive = false;
  if(recognition){
    try{ recognition.stop(); }catch(e){}
  }
  updateMicUI(false);
}

function toggleMic(){
  if(micActive) stopListening(); else startListening();
  playSound();
}

function updateMicUI(listening){
  micBtn.setAttribute('aria-pressed', listening ? 'true' : 'false');
  if(listening){
    micBtn.classList.add('listening');
  } else {
    micBtn.classList.remove('listening');
  }
}

/* Utambuzi - handle results (EN + SW) */
function handleSpeechResult(event){
  for(let i=event.resultIndex; i<event.results.length; ++i){
    if(event.results[i].isFinal){
      const spokenRaw = event.results[i][0].transcript.trim();
      const spoken = spokenRaw.toLowerCase();
      console.log('Heard:', spokenRaw);

      // ----- NAME detection (en) and JINA (sw) -----
      let nameMatched = null;
      const swNameMatch = spoken.match(/(?:jina\s*(?:ni)?\s*|mimi\s*ni\s*)([a-zA-Z\u00C0-\u017F\s]+)/i);
      if(swNameMatch) nameMatched = swNameMatch[1].trim();
      const enNameMatch = spoken.match(/(?:my name is|name is|i am)\s+([a-zA-Z\u00C0-\u017F\s]+)/i);
      if(!nameMatched && enNameMatch) nameMatched = enNameMatch[1].trim();
      if(nameMatched){
        document.getElementById('farmerName').value = capitalizeWords(nameMatched);
        speakText(currentLang==='en'?`Hello ${nameMatched}`:`Habari ${nameMatched}`, 'female');
      }

      // ----- GENDER detection -----
      if(spoken.includes('male') || spoken.includes('mwanaume') || spoken.includes('me')) {
        document.getElementById('gender').value = 'male';
      } else if(spoken.includes('female') || spoken.includes('mwanamke') || spoken.includes('female')) {
        document.getElementById('gender').value = 'female';
      }

      // ----- REGION detection -----
      regionsAPI.forEach(r=>{
        if(spoken.includes(r.name.toLowerCase())){
          document.getElementById('region').value = JSON.stringify(r);
        }
      });

      // ----- CROP detection -----
      cropsEN.forEach(cEn => {
        if(spoken.includes(cEn.toLowerCase())) {
          cropSelect.value = cEn;
          document.querySelectorAll('.thumb').forEach(x=>x.classList.remove('selected'));
          const matchThumb = Array.from(document.querySelectorAll('.thumb')).find(t => (t.dataset.crop||'').toLowerCase() === (cEn.toLowerCase()));
          if(matchThumb) matchThumb.classList.add('selected');
        }
      });
      cropsSW.forEach((cSw, idx) => {
        if(spoken.includes(cSw.toLowerCase())){
          const cEn = cropsEN[idx];
          cropSelect.value = cEn;
          document.querySelectorAll('.thumb').forEach(t => t.classList.remove('selected'));
          const matchThumb = Array.from(document.querySelectorAll('.thumb')).find(t => (t.dataset.crop||'').toLowerCase() === (cEn.toLowerCase()));
          if(matchThumb) matchThumb.classList.add('selected');
        }
      });

      // ----- COMMANDS (EN + SW) -----
      if(spoken.includes('show trend') || spoken.includes('onyesha trend') || spoken.includes('onyesha tabia') || spoken.includes('onyesha mwenendo')){
        showTrend();
      }
      if(spoken.includes('show advice') || spoken.includes('onyesha ushauri') || spoken.includes('ushauri') || spoken.includes('show advice')){
        showAdvice();
      }
      if(spoken.includes('check weather') || spoken.includes('angalia hali ya hewa') || spoken.includes('hali ya hewa')){
        checkWeather();
      }
      if(spoken.includes('forecast') || spoken.includes('utafitia') || spoken.includes('matangazo') || spoken.includes('tabiri')){
        forecast5Days();
      }
    }
  }
}

function capitalizeWords(s){
  return s.split(' ').map(p => p.charAt(0).toUpperCase()+p.slice(1)).join(' ');
}
micBtn.addEventListener('click', (e)=>{ e.preventDefault(); toggleMic(); });
updateMicUI(false);
/* ========== LEAFLET MAP SECTION ========== */
let map = null;
let userMarker = null;

/* Haversine formula kupata mkoa sahihi */
function haversineDistance(lat1, lon1, lat2, lon2) {
  const R = 6371;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a =
    Math.sin(dLat/2) ** 2 +
    Math.cos(lat1 * Math.PI/180) *
    Math.cos(lat2 * Math.PI/180) *
    Math.sin(dLon/2) ** 2;

  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

function findNearestRegion(lat, lng) {
  let nearest = null;
  let minDist = Infinity;

  regionsAPI.forEach(r => {
    const d = haversineDistance(lat, lng, r.lat, r.lng);
    if (d < minDist) {
      minDist = d;
      nearest = r;
    }
  });

  return nearest;
}

/* Initialize map */
function initMap(lat = -6.7924, lng = 39.2083) {
  if (!map) {
    map = L.map('map').setView([lat, lng], 8);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);
  } else {
    map.setView([lat, lng], 10);
  }
}

/* Button event */
document.getElementById("useLocationBtn").addEventListener("click", getLocation);

/* Get user location */
function getLocation() {
  document.getElementById("locSpinner").style.display = "block";

  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(showPosition, showError, {
      enableHighAccuracy: true,
      timeout: 10000
    });
  } else {
    alert("Geolocation not supported.");
    document.getElementById("locSpinner").style.display = "none";
  }
}

/* Show position */
async function showPosition(pos) {
  const lat = pos.coords.latitude;
  const lng = pos.coords.longitude;

  document.getElementById("locSpinner").style.display = "none";

  initMap(lat, lng);

  if (userMarker) userMarker.remove();
  userMarker = L.marker([lat, lng]).addTo(map);

  // Reverse geocoding
  let streetText = "";
  try {
    const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`;
    const res = await fetch(url);
    const data = await res.json();

    const a = data.address;
    streetText = `${a.road || ""}, ${a.suburb || ""}, ${a.town || a.city || ""}, ${a.state || ""}`;
  } catch (e) {
    streetText = `Lat: ${lat.toFixed(4)}, Lng: ${lng.toFixed(4)}`;
  }

  userMarker.bindPopup(streetText).openPopup();

  // Update region
  const nearest = findNearestRegion(lat, lng);
  if (nearest) {
    document.getElementById("region").value = JSON.stringify(nearest);
  }

  // Trigger weather function (hii inatoka kwenye system yako)
  checkWeatherAt(lat, lng);
}

/* Error */
function showError(error) {
  document.getElementById("locSpinner").style.display = "none";
  let msg = "Error getting location.";

  if (error.code === 1) msg = "Permission denied.";
  if (error.code === 2) msg = "Location unavailable.";
  if (error.code === 3) msg = "Timeout.";

  alert(msg);
}

/* Load map on start */
window.addEventListener("load", () => initMap());


</script>
</body>
</html>
